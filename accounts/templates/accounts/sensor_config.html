{% extends "base.html" %}
{% load static %}

{% block title %}Sensor Configuration{% endblock %}

{% block nav_title %}Sensor Configuration{% endblock %}

{% block nav_items %}
    <a href="{% url 'home' %}" class="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2">Dashboard</a>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg overflow-hidden transition-colors">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 transition-colors">Configuración del Sensor</h2>
                
                <!-- Formulario de configuración WiFi -->
                <form method="post" class="space-y-6">
                    {% csrf_token %}
                    <div class="space-y-4">
                        <div>
                            <label for="ssid" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition-colors">
                                Nombre de Red (SSID)
                            </label>
                            <input type="text" name="ssid" id="ssid" required
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition-colors">
                                Contraseña WiFi
                            </label>
                            <input type="password" name="password" id="password" required
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors">
                        </div>
                    </div>
                    <div class="pt-4">
                        <button type="submit"
                                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            Guardar Configuración
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Datos del Sensor -->
        <div class="mt-8 bg-white dark:bg-gray-800 shadow-lg rounded-lg overflow-hidden transition-colors">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white transition-colors">Datos del Sensor</h2>
                    <button onclick="exportToCSV()" 
                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                        Exportar CSV
                    </button>
                </div>
                
                <!-- Gráfica en tiempo real -->
                <div class="h-64 mb-6">
                    <canvas id="sensorChart"></canvas>
                </div>

                <!-- Tabla de datos -->
                <div class="mt-6 overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Valor del Sensor</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Humedad (%)</th>
                            </tr>
                        </thead>
                        <tbody id="sensorData" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Los datos se insertarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;
let sensorData = [];

// Inicializar la gráfica
function initChart() {
    const ctx = document.getElementById('sensorChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Humedad (%)',
                data: [],
                borderColor: 'rgb(59, 130, 246)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

// Actualizar datos
function updateData() {
    fetch('/api/sensor-data/')
        .then(response => response.json())
        .then(data => {
            sensorData = data;
            updateChart();
            updateTable();
        });
}

// Actualizar gráfica
function updateChart() {
    const labels = sensorData.map(d => new Date(d.timestamp).toLocaleTimeString());
    const values = sensorData.map(d => d.humidity_percent);
    
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update();
}

// Actualizar tabla
function updateTable() {
    const tbody = document.getElementById('sensorData');
    tbody.innerHTML = sensorData.map(d => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${new Date(d.timestamp).toLocaleString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${d.sensor_value}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${d.humidity_percent}%</td>
        </tr>
    `).join('');
}

// Exportar a CSV
function exportToCSV() {
    const headers = ['Fecha', 'Valor del Sensor', 'Humedad (%)'];
    const csvData = sensorData.map(d => [
        new Date(d.timestamp).toLocaleString(),
        d.sensor_value,
        d.humidity_percent
    ]);
    
    const csvContent = [
        headers.join(','),
        ...csvData.map(row => row.join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'sensor_data.csv';
    link.click();
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    initChart();
    updateData();
    // Actualizar datos cada 2 segundos
    setInterval(updateData, 2000);
});
</script>
{% endblock %}